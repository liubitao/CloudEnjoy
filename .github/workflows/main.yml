name: iOS PR Comment Triggered Format

on:
  issue_comment:
    types: [created]

jobs:
  format-on-comment:
    # Ensure it only runs on PRs, when the comment starts with /format
    if: github.event.issue.pull_request && startsWith(github.event.comment.body, '/format')
    runs-on: macos-latest
    timeout-minutes: 15
    permissions:
      contents: write  # Required to push changes
      pull-requests: write # Required to post comments

    steps:
      - name: Get PR info
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_url="${{ github.event.issue.pull_request.url }}"
          pr_json=$(gh api "$pr_url")
          echo "head_ref=$(echo "$pr_json" | jq -r '.head.ref')" >> $GITHUB_OUTPUT
          echo "base_ref=$(echo "$pr_json" | jq -r '.base.ref')" >> $GITHUB_OUTPUT

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.head_ref }}
          fetch-depth: 0 # Crucial for diffing against base

      - name: Install SwiftFormat
        run: brew install swiftformat

      - name: Fetch base branch
        run: git fetch origin ${{ steps.pr.outputs.base_ref }}

      - name: Run SwiftFormat (Only Changed Files)
        run: |
          # 1. 强制 Git 不转义中文路径
          git config core.quotepath false
          
          # 2. 获取变更文件，并处理中文/空格路径
          # -z 使用 NUL 字符分隔文件名，防止空格和换行符导致路径断开
          # xargs -0 配合 -I {} 可以安全处理包含中文和空格的路径
          git diff --name-only -z origin/${{ steps.pr.outputs.base_ref }}...HEAD -- '*.swift' | \
          xargs -0 -I {} sh -c 'if [ -f "{}" ]; then swiftformat "{}" --config .swiftformat; fi'

      - name: Commit and Push changes
        run: |
          # 同样在提交前确保路径显示正常
          git config core.quotepath false
          
          if git diff --quiet; then
            echo "No formatting changes"
            exit 0
          fi
          
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # 使用 git add . 自动处理所有变更（包括中文路径）
          git add .
          git commit -m "chore: swiftformat (auto-formatted)"
          git push origin HEAD:${{ steps.pr.outputs.head_ref }}

      - name: Comment result
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.issue.number }} --body "✅ SwiftFormat execution finished. Please check the latest commit."
