name: iOS PR Comment Triggered Format

on:
  issue_comment:
    types: [created]

jobs:
  format-on-comment:
    # 仅在 PR 评论且评论内容为 /format 时触发
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body, '/format') &&
      github.event.comment.user.login != github.event.pull_request.user.login
    runs-on: macos-latest
    timeout-minutes: 15

    steps:
            - name: Get PR info
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_url="${{ github.event.issue.pull_request.url }}"
          pr_json=$(gh api "$pr_url")
          echo "head_ref=$(echo "$pr_json" | jq -r '.head.ref')" >> $GITHUB_OUTPUT
          echo "base_ref=$(echo "$pr_json" | jq -r '.base.ref')" >> $GITHUB_OUTPUT
          echo "author=$(echo "$pr_json" | jq -r '.user.login')" >> $GITHUB_OUTPUT

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.head_ref }}
          fetch-depth: 0

      - name: Install SwiftFormat
        run: brew install swiftformat || brew upgrade swiftformat

      - name: Fetch base branch
        run: git fetch origin ${{ steps.pr.outputs.base_ref }}

      - name: Detect changed Swift files
        id: diff
        run: |
          files=$(git diff --name-only origin/${{ steps.pr.outputs.base_ref }}...HEAD -- '*.swift')
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run SwiftFormat (only changed files)
        if: steps.diff.outputs.files != ''
        run: |
          echo "Formatting files:" 
          echo "${{ steps.diff.outputs.files }}"
          swiftformat ${{ steps.diff.outputs.files }} --config .swiftformat

      - name: Commit formatted changes
        if: steps.diff.outputs.files != ''
        run: |
          if git diff --quiet; then
            echo "No formatting changes"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -am "chore: swiftformat"
          git push

      - name: Comment result
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            -X POST \
            -f body='✅ SwiftFormat 已执行完成，如有代码变更请重新 review'
