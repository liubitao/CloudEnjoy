name: iOS PR & Merge Pipeline

on:
  pull_request_review:
    types: [submitted]
  issue_comment:
    types: [created]

jobs:
  format-after-approve:
    # 仅在第一次 Approved 且非作者本人时触发
    if: |
      github.event.review.state == 'approved' &&
      github.event.review.user.login != github.event.pull_request.user.login
    runs-on: macos-latest
    timeout-minutes: 15

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Install SwiftFormat
        run: brew install swiftformat || brew upgrade swiftformat

      - name: Detect changed Swift files
        id: diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          files=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD -- '*.swift')
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run SwiftFormat (only changed files)
        if: steps.diff.outputs.files != ''
        run: |
          echo "Formatting files:" 
          echo "${{ steps.diff.outputs.files }}"
          swiftformat ${{ steps.diff.outputs.files }} --config .swiftformat

      - name: Commit formatted changes
        if: steps.diff.outputs.files != ''
        run: |
          if git diff --quiet; then
            echo "No formatting changes"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -am "chore: swiftformat"
          git push

      - name: Re-request review
        if: steps.diff.outputs.files != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api \
            repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/requested_reviewers \
            -X POST \
            -f reviewers='[]'
