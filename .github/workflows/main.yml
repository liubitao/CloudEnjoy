name: iOS PR Comment Triggered Format

on:
  issue_comment:
    types: [created]

jobs:
  format-on-comment:
    # Ensure it only runs on PRs, when the comment starts with /format
    if: github.event.issue.pull_request && startsWith(github.event.comment.body, '/format')
    runs-on: macos-latest
    timeout-minutes: 15
    permissions:
      contents: write  # Required to push changes
      pull-requests: write # Required to post comments

    steps:
      - name: Get PR info
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          pr_url="${{ github.event.issue.pull_request.url }}"
          pr_json=$(gh api "$pr_url")
          echo "head_ref=$(echo "$pr_json" | jq -r '.head.ref')" >> $GITHUB_OUTPUT
          echo "base_ref=$(echo "$pr_json" | jq -r '.base.ref')" >> $GITHUB_OUTPUT

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr.outputs.head_ref }}
          fetch-depth: 0 # Crucial for diffing against base

      - name: Install SwiftFormat
        run: brew install swiftformat

      - name: Fetch base branch
        run: git fetch origin ${{ steps.pr.outputs.base_ref }}

      - name: Run SwiftFormat (only changed files)
        run: |
          # Get list of changed .swift files
          files=$(git diff --name-only origin/${{ steps.pr.outputs.base_ref }}...HEAD -- '*.swift' | xargs)
          
          if [ -n "$files" ]; then
            echo "Formatting: $files"
            swiftformat $files --config .swiftformat
          else
            echo "No swift files changed."
          fi

      - name: Commit and Push changes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if git diff --quiet; then
            echo "No formatting changes needed."
            exit 0
          fi
          
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore: swiftformat"
          git push origin HEAD:${{ steps.pr.outputs.head_ref }}

      - name: Comment result
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.issue.number }} --body "âœ… SwiftFormat execution finished. Please check the latest commit."
